{
  "id": "instagram_auto_dm",
  "name": "Instagram DM Auto-Response (Darja)",
  "category": "social_media",
  "description": "Intelligent Instagram DM handler that responds to common queries in Darja/French, qualifies leads by detecting purchase intent, forwards product inquiries with images to WhatsApp, and escalates complex issues to human team",
  "keywords": ["instagram", "dm", "darja", "social media", "auto-response", "engagement"],
  "required_inputs": [
    {
      "name": "instagram_business_id",
      "type": "string",
      "label": "Instagram Business Account ID",
      "required": true
    },
    {
      "name": "instagram_access_token",
      "type": "string",
      "label": "Instagram Graph API Token",
      "required": true
    }
  ],
  "optional_inputs": [
    {
      "name": "forward_to_whatsapp",
      "type": "string",
      "label": "NumÃ©ro WhatsApp pour leads (+213XXXXXXXXX)",
      "required": false
    },
    {
      "name": "product_catalog_sheet",
      "type": "string",
      "label": "Google Sheet ID (Catalogue produits)",
      "required": false
    },
    {
      "name": "response_delay_seconds",
      "type": "number",
      "label": "DÃ©lai avant rÃ©ponse (secondes)",
      "default": 3,
      "min": 0,
      "max": 30
    }
  ],
  "n8n_json": {
    "name": "Instagram_Auto_DM_{{user_id}}",
    "nodes": [
      {
        "parameters": {
          "path": "instagram-webhook",
          "options": {}
        },
        "name": "Instagram Webhook",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1,
        "position": [250, 300],
        "id": "webhook-node"
      },
      {
        "parameters": {
          "functionCode": "const webhookData = items[0].json;\nconst entry = webhookData.entry?.[0];\nconst messaging = entry?.messaging?.[0];\nconst message = messaging?.message;\n\nif (!message) return [];\n\nconst senderId = messaging.sender.id;\nconst messageText = message.text || '';\nconst messageTime = messaging.timestamp;\n\n// Language detection\nconst hasDarjaWords = /(ÙˆØ§Ø´|Ø±Ø§Ùƒ|ÙƒÙŠÙ…Ø§|Ø¨ØµØ­|Ø´ÙƒÙˆÙ†|ÙƒØ§ÙŠÙ†|Ø´Ø­Ø§Ù„)/i.test(messageText);\nconst hasFrenchWords = /(bonjour|prix|disponible|merci|commander)/i.test(messageText);\nconst language = hasDarjaWords ? 'darja' : (hasFrenchWords ? 'fr' : 'ar');\n\n// Intent detection\nconst greetingPattern = /(salam|Ø³Ù„Ø§Ù…|bonjour|hi|hello)/i;\nconst pricePattern = /(prix|Ø³Ø¹Ø±|combien|Ø«Ù…Ù†|Ø´Ø­Ø§Ù„)/i;\nconst availabilityPattern = /(disponible|Ù…ØªÙˆÙØ±|ÙƒØ§ÙŠÙ†|stock)/i;\nconst orderPattern = /(commander|Ø·Ù„Ø¨|acheter|Ø´Ø±Ø§Ø¡)/i;\nconst locationPattern = /(livraison|ØªÙˆØµÙŠÙ„|wilaya|ÙˆÙ„Ø§ÙŠØ©)/i;\n\nconst intents = {\n  greeting: greetingPattern.test(messageText),\n  price_inquiry: pricePattern.test(messageText),\n  availability: availabilityPattern.test(messageText),\n  order_intent: orderPattern.test(messageText),\n  delivery_info: locationPattern.test(messageText)\n};\n\nconst isQualifiedLead = intents.price_inquiry || intents.order_intent;\n\nreturn [{\n  json: {\n    sender_id: senderId,\n    message: messageText,\n    timestamp: messageTime,\n    language: language,\n    intents: intents,\n    is_lead: isQualifiedLead\n  }\n}];"
        },
        "name": "Parse DM & Detect Intent",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [450, 300],
        "id": "parse-node"
      },
      {
        "parameters": {
          "amount": "={{response_delay_seconds}}",
          "unit": "seconds"
        },
        "name": "Natural Delay",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1,
        "position": [650, 300],
        "id": "delay-node"
      },
      {
        "parameters": {
          "functionCode": "const language = items[0].json.language;\nconst intents = items[0].json.intents;\n\nconst responses = {\n  darja: {\n    greeting: 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…! ðŸ‘‹ ÙƒÙŠÙØ§Ø´ Ù†Ù‚Ø¯Ø± Ù†Ø¹Ø§ÙˆÙ†Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ',\n    price: 'Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…ØªØ§Ø¹ Ø§Ù„Ù…Ù†ØªÙˆØ¬Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨ÙˆØ³Øª. ÙˆØ§Ø´ ØªØ­Ø¨ Ù†ÙÙ‡Ù…Ùƒ Ø¹Ù„Ù‰ Ù…Ù†ØªÙˆØ¬ Ù…Ø¹ÙŠÙ†ØŸ',\n    availability: 'Ø§ÙŠÙ‡ ÙƒØ§ÙŠÙ† ÙÙŠ stock! ðŸ“¦ ÙˆØ§Ø´ ØªØ­Ø¨ Ù†Ø¨Ø¹ØªÙ„Ùƒ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù„Ù‰ WhatsAppØŸ',\n    order: 'Ø¨Ø§Ø´ ØªÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŒ Ø§Ø¨Ø¹ØªÙ„ÙŠ Ø±Ù‚Ù…Ùƒ Ø¹Ù„Ù‰ WhatsApp ÙˆÙ†ØªÙˆØ§ØµÙ„Ùˆ Ù…Ø¹Ø§Ùƒ! ðŸ“±',\n    delivery: 'Ù†ÙˆØµÙ„Ùˆ Ù„ÙƒØ§Ù…Ù„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ Yalidine. Ø§Ù„Ù„ÙŠÙØ±ÙŠØ²ÙˆÙ† ØªØ§Ø®Ø° 2-4 Ø£ÙŠØ§Ù…. ðŸšš',\n    default: 'Ø´ÙƒØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø¬! Ø±Ø§Ù†ÙŠ Ù‡Ù†Ø§ Ø¨Ø§Ø´ Ù†Ø¬Ø§ÙˆØ¨Ùƒ. Ø´Ù†ÙˆØ§ ØªØ­Ø¨ ØªØ¹Ø±ÙØŸ ðŸ˜Š'\n  },\n  fr: {\n    greeting: 'Bonjour! ðŸ‘‹ Comment puis-je vous aider?',\n    price: 'Les prix sont dans nos posts. Quel produit vous intÃ©resse?',\n    availability: 'Oui, disponible en stock! ðŸ“¦ Souhaitez-vous plus de dÃ©tails sur WhatsApp?',\n    order: 'Pour commander, envoyez-nous votre numÃ©ro WhatsApp et on vous contacte! ðŸ“±',\n    delivery: 'Livraison dans toutes les wilayas via Yalidine (2-4 jours). ðŸšš',\n    default: 'Merci pour votre message! Je suis lÃ  pour vous aider. Que voulez-vous savoir? ðŸ˜Š'\n  }\n};\n\nconst lang = language === 'darja' ? 'darja' : 'fr';\nlet responseText = responses[lang].default;\n\nif (intents.greeting) responseText = responses[lang].greeting;\nelse if (intents.price_inquiry) responseText = responses[lang].price;\nelse if (intents.availability) responseText = responses[lang].availability;\nelse if (intents.order_intent) responseText = responses[lang].order;\nelse if (intents.delivery_info) responseText = responses[lang].delivery;\n\nreturn [{\n  json: {\n    ...items[0].json,\n    response_text: responseText\n  }\n}];"
        },
        "name": "Generate Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [850, 300],
        "id": "generate-response"
      },
      {
        "parameters": {
          "url": "=https://graph.facebook.com/v18.0/me/messages",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "access_token",
                "value": "={{instagram_access_token}}"
              }
            ]
          },
          "sendBody": true,
          "bodyParametersJson": "={\n  \"recipient\": {\n    \"id\": \"{{$json.sender_id}}\"\n  },\n  \"message\": {\n    \"text\": \"{{$json.response_text}}\"\n  }\n}",
          "options": {}
        },
        "name": "Send Instagram Reply",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [1050, 300],
        "id": "send-reply"
      },
      {
        "parameters": {
          "conditions": {
            "boolean": [
              {
                "value1": "={{$json.is_lead}}",
                "value2": true
              }
            ]
          }
        },
        "name": "Is Qualified Lead?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [1050, 450],
        "id": "lead-check"
      },
      {
        "parameters": {
          "url": "=https://graph.facebook.com/v18.0/{{$json.sender_id}}",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "fields",
                "value": "name,username,profile_pic"
              },
              {
                "name": "access_token",
                "value": "={{instagram_access_token}}"
              }
            ]
          }
        },
        "name": "Get User Profile",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [1250, 400],
        "id": "get-profile"
      },
      {
        "parameters": {
          "url": "=https://graph.facebook.com/v18.0/{{whatsapp_phone_id}}/messages",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "=Bearer {{whatsapp_token}}"
              }
            ]
          },
          "sendBody": true,
          "bodyParametersJson": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{forward_to_whatsapp}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"ðŸ”¥ *Nouveau Lead Instagram*\\n\\n*Nom:* {{$json.name}}\\n*Username:* @{{$json.username}}\\n*Message:* {{$node[\"Parse DM & Detect Intent\"].json.message}}\\n*Intent:* Prix/Commande\\n\\nRÃ©pondre rapidement sur Instagram!\"\n  }\n}",
          "options": {}
        },
        "name": "Forward Lead to WhatsApp",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [1450, 400],
        "id": "forward-whatsapp"
      },
      {
        "parameters": {
          "resource": "sheet",
          "operation": "append",
          "documentId": "={{google_sheet_id}}",
          "sheetName": "Instagram Leads",
          "columns": {
            "mappings": [
              {
                "column": "Timestamp",
                "value": "={{$json.timestamp}}"
              },
              {
                "column": "Name",
                "value": "={{$json.name}}"
              },
              {
                "column": "Username",
                "value": "={{$json.username}}"
              },
              {
                "column": "Message",
                "value": "={{$node[\"Parse DM & Detect Intent\"].json.message}}"
              },
              {
                "column": "Language",
                "value": "={{$node[\"Parse DM & Detect Intent\"].json.language}}"
              },
              {
                "column": "Intent",
                "value": "={{Object.keys($node[\"Parse DM & Detect Intent\"].json.intents).filter(k => $node[\"Parse DM & Detect Intent\"].json.intents[k]).join(', ')}}"
              },
              {
                "column": "Response Sent",
                "value": "={{$node[\"Generate Response\"].json.response_text}}"
              }
            ]
          }
        },
        "name": "Log to Google Sheets",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4,
        "position": [1450, 500],
        "id": "log-sheet",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "google_sheets_user_{{user_id}}",
            "name": "Google Sheets Account"
          }
        }
      }
    ],
    "connections": {
      "Instagram Webhook": {
        "main": [
          [
            {
              "node": "Parse DM & Detect Intent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse DM & Detect Intent": {
        "main": [
          [
            {
              "node": "Natural Delay",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Natural Delay": {
        "main": [
          [
            {
              "node": "Generate Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Response": {
        "main": [
          [
            {
              "node": "Send Instagram Reply",
              "type": "main",
              "index": 0
            },
            {
              "node": "Is Qualified Lead?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is Qualified Lead?": {
        "main": [
          [
            {
              "node": "Get User Profile",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get User Profile": {
        "main": [
          [
            {
              "node": "Forward Lead to WhatsApp",
              "type": "main",
              "index": 0
            },
            {
              "node": "Log to Google Sheets",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "executionOrder": "v1"
    }
  },
  "estimated_cost_dzd": 9.0,
  "avg_execution_time_seconds": 6
}
